{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Úkol 4 - Diskriminační analýza\"\nsubtitle: \"4ST512 Vícerozměrná statistika\"\nauthor: \"Jiří Filip\"\noutput: \n  pdf_document:\n    df_print: kable\n---\n\n\n```{r include = FALSE}\nknitr::opts_chunk$set(echo=FALSE)\n```\n\n```{r include = FALSE}\n\nlibrary(foreign)\nlibrary(tidyverse)\nlibrary(bootstrap)\nlibrary(ggfortify)\n\nlibrary(haven)\nlibrary(reshape)\n\nlibrary(gridExtra)\n\nlibrary(MASS)\nlibrary(caret)\n\nlibrary(klaR)\nlibrary(mvoutlier)\nlibrary(HH)\n\nlibrary(biotools)\nlibrary(corrplot)\n\nselect <- dplyr::select\n```\n\n\n```{r}\ndata.raw <- data.csv(\"data/ukol4.csv\")\n    \nvariable.names <- c(\"Obvod břicha\", \"Obvod předloktí (průměr)\", \"Obvod kolene (průměr)\")\n\ndata.train <-\n  data.raw %>%\n    filter(pohlavi != 0) %>%\n    mutate(pohlavi = factor(pohlavi, labels = c(\"muž\", \"žena\")))  \n\ndata.test <- \n  data.raw %>%\n    filter(pohlavi == 0) %>%\n    mutate(pohlavi = factor(pohlavi))  \n```\n# Úvod\n\nV této analýze se budeme zaobírat údaji o tělesných rozměrech mužů a žen (obvod břicha, předloktí a kolene) a do jaké míry lze tyto rozměry využít k rozhodnutí o pohlaví jedince. Využijeme metodu Lineární diskriminační analýzy (LDA). Data rovněž obsahují údaje o 10 jedincí neznámého pohlaví, jež se pokusíme zařadit buďto jako muže, nebo ženu.\n\n```{r}\nhead(data.train)\n```\n\n# Průzkum dat z hlediska předpokladů LDA\n\nNejprve data prozkoumáme z hlediska předpokladů diskriminační analýzy. Data popisují muže a ženy a jejich tělesné rozměry. Naším cílem bude na základě těchto tělesných rozměrů rozhodnout o pohlaví deseti neznámých jedinců.\n\n\n\n## Průměry\n\nNejprve se podívejme, jak se jednotlivé třídy (muž a žena) liší, co se týče průměrů tělesných rozměrů. Vidíme, že všechny rozměry se nějakým způsobem liší - to nám dopomůže k lepší diskriminaci pohlaví. \n\n```{r}\ndata.train %>%\n  select(pohlavi, o4, o8, o9) %>%\n  group_by(pohlavi) %>%\n  summarise(o4 = mean(o4), o8 = mean(o8), o9 = mean(o9))\n```\n\n## Směrodatné odchylky\n\nStejně tak se podívejme na směrodatné odchylky rozměrů. Ty nám (společně s informacemi o průměrech) dávají nějakou představu o tom, jak se jednotlivé distribuce rozměrů ve třídách (muž a žena) překrývají. Vidíme, že u prvního rozměru se odchylky liší výrazně, u druhých dvou už méně (až zanedbatelně). Toto by však mohlo být způsobeno jinou škálou, kdy desetinný rozdíl u druhých dvou rozměrů znamená více než u prvního.\n\n```{r}\ndata.train %>%\n  select(pohlavi, o4, o8, o9) %>%\n  group_by(pohlavi) %>%\n  summarise(o4 = sd(o4), o8 = sd(o8), o9 = sd(o9))\n```\n\n## Shapirův-Wilkův test\n\nDalší tabulka představuje výsledky (p-hodnoty) Shapirova-Wilkova testu s nulovou hypotézou o normalitě dat. Lze vidět, že na hladině významnosti 5 % můžeme zamítnout hypotézu o normalitě dat u všech obvodů ženy a u prvního obvodu muže.\n\n```{r}\noptions(scipen = 10)\n\ndata.train %>%\n  select(pohlavi, o4, o8, o9) %>%\n  group_by(pohlavi) %>%\n  summarise(o4 = shapiro.test(o4)$p.value, o8 = shapiro.test(o8)$p.value, o9 = shapiro.test(o9)$p.value)\n```\n\n\n\n## Kovarianční matice\n\nPorovnejme ještě konvarianční matice mužů a žen. Vidíme, že se dvě kovarianční matice od sebe značně liší.\n\n### Muž\n\n```{r}\ncov(data.train %>% filter(pohlavi == \"muž\") %>% select(o4, o8, o9)) %>% tbl_df\n```\n\n\n### Žena\n\n```{r}\ncov(data.train %>% filter(pohlavi == \"žena\") %>% select(o4, o8, o9)) %>% tbl_df\n```\n\nTo potvrzuje i Boxův M test, u něhož na hladině významnosti 5 % zamítáme hypotézu o homogenitě kovariančních matic.\n\n```{r}\n#boxM\nboxM(data.train %>% select(o4, o8, o9), data.train$pohlavi)\n```\n\nPro přehled si ještě zobrazme jednotlivá rozdělení tělesných rozměrů pro muže a pro ženy. Vidíme, že zdaleka nejméně se překrývají dvě rozdělení u obvodu předloktí. Očekávali bychom tak, že obvod předloktí bude nejlépe diskriminovat. \n\n```{r fig.height=5}\n\npl1 <-\n  data.train[,c(\"pohlavi\", \"o4\")] %>%\n    ggplot() +\n    geom_density(aes(o4, fill = pohlavi), alpha = 0.5) +\n    ggtitle(\"Obvod břicha\") +\n    theme(plot.title = element_text(hjust = 0.5))\n\npl2 <- \n  data.train[,c(\"pohlavi\", \"o8\")] %>%\n    ggplot() +\n    geom_density(aes(o8, fill = pohlavi), alpha = 0.5) +\n    ggtitle(\"Obvod předloktí (průměr)\") +\n    theme(plot.title = element_text(hjust = 0.5))\n\n\npl3 <- \n  data.train[,c(\"pohlavi\", \"o9\")] %>%\n    ggplot() +\n    geom_density(aes(o9, fill = pohlavi), alpha = 0.5) +\n    ggtitle(\"Obvod kolene (průměr)\") +\n    theme(plot.title = element_text(hjust = 0.5))\n\n\ngrid.arrange(pl1, pl2, pl3)\n```\n\n# LDA\n\nNyní spusťme LDA na trénovacích datech a podívejme se na jednotlivé koeficienty u diskriminační funkce. Největší absolutní hodnota koeficientu je právě u obvodu předloktí, a sice $ 0.754 $. Nejhůře potom diskriminuje obvod břicha s absolutní hodnotou koeficientu $ 0.039 $.\n\n```{r}\nfit <- lda(pohlavi ~ o4 + o8 + o9, data.train)\n```\n\n$$ LD_1 = (0.039 * o4) + (-0.754 * o8) + (0.148 * o9)  $$\n\nZde vidíme jednotlivé hodnoty transformované pomocí lineární diskriminační funkce. Vidíme zde rozdělení pro muže a ženy a lze vidět, že po transformaci se překrývají jen v menší části uprostřed. \n\n```{r}\ndata.train.scaled <- \n  data.train %>%\n    mutate(o4 = scale(o4), o8 = scale(o8), o9 = scale(o9))\n\ndata.test.scaled <- \n  data.test %>%\n    mutate(o4 = scale(o4), o8 = scale(o8), o9 = scale(o9))\n\ntrain.lda.fit <- lda(pohlavi ~ o4 + o8 + o9, data.train.scaled)\n\ndata.train.matrix <- \n  data.train.scaled %>%\n    select(o4, o8, o9) %>%\n      as.matrix()\n\ndata.discriminated <- t(t(train.lda.fit$scaling) %*% t(data.train.matrix)) %>% as.data.frame()\n\ndata.discriminated$LD2 <- rep(1, nrow(data.discriminated))\ndata.discriminated$class <- data.train$pohlavi\n\ndata.discriminated %>% \n  ggplot() +\n  geom_density(aes(LD1, fill = class), alpha = 0.8)\n\n#plot(fit, type=\"both\")\n```\n\nZde můžeme vidět, jak lze pohlaví rozdělit na původním prostoru proměnných. Červeně jsou označeny instance, jež jsou nesprávně klasifikovány. Ze zběžného pohledu můžeme vidět, že většina instancí je správně klasifikována a pouze malá část jich je zabarvena červeně. To nám napovídá, že klasifikace má vysokou přesnost. Pojďme se nyní na tuto přesnost podívat v konkrétních číslech.\n\n```{r}\npartimat(pohlavi ~ o4 + o8 + o9, data = data.train, method = \"lda\", plot.matrix = TRUE, name = variable.names)\n```\n\n\n\n\n\n# Ověření na trénovacích datech\n\nNyní predikujme hodnoty pohlaví za základě dat, s nimiž jsme spustili LDA a podívejme se na matici záměn. Vidíme, že na trénovací množině je odhad přesnosti LDA přibližně $93 \\%$. LDA chybně predikovalo 12 žen jako muže a 24 mužů jako ženy.\nKromě toho se zde vyskytují údaje jako sensitivita a specificita. Sensitivita nám říká, že přibližně $ 90 \\% $ mužů bylo správně klasifikováno jako muži. Specificita nám pak říká, že přiblížně $ 95 \\% $ žen bylo správně klasifikováno jako ženy.\n\n\n```{r}\ndata.train.predicted <- predict(fit, data.train)\ndata.train$lda_prediction <- data.train.predicted$class\n\ndata.test.predicted <- predict(fit, data.test)\ndata.test$lda_prediction <- data.test.predicted$class\n\nconfusionMatrix(data.train$lda_prediction, data.train$pohlavi)\n```\n\nPřesnost byla však vypočtena na trénovacích datech (na nichž jsme LDA spustili). Pro spolehlivější odhad přesnosti použijeme desetinásobnou křížovou validaci. Průměrná přesnost napříč deseti validacemi je přibližně $ 93 \\% $. Tedy stejně, jako kdybybychom použili k ověření jen trénovací data. Získali jsme tedy relativně přesný odhad. Máme jistotu přibližně $ 93 \\% $, že jedince správně klasifikujeme.\n\n```{r}\nldaFit <- train(pohlavi ~ o4 + o8 + o9, data = data.train, method = \"lda\", preProcess = c(\"center\", \"scale\"), trControl = trainControl(method = \"cv\"), tuneLength = 10)\n\nconfusionMatrix.train(ldaFit)\n```\n\n# Jistota klasifikace nových instancí\n\nNásledující graf zobrazuje, s jakou pravděpodobností náleží jedinec do dané třídy. Můžeme z něj vyčíst, zda si můžeme být klasifikací jistí (v případě, kdy jasně převládá velikost pravděpodobnosti jednoho z pohlaví), nebo ne (v případě, kdy jsou velikosti téměř vyrovnané).\n\n```{r echo=FALSE, results=\"hide\", warning=FALSE, message=FALSE}\ntest.pred.viz <- data.test.predicted %>% as.data.frame()\ntest.pred.viz$instance <- 1:nrow(test.pred.viz)\ntest.pred.viz <- \n  test.pred.viz %>%\n    select(-class, -LD1)\n\n\n\ntest.pred.viz2 <- test.pred.viz %>% select(instance, posterior.muž, posterior.žena) %>% mutate(instance = as.factor(instance)) %>% melt\n\nggplot(test.pred.viz2, aes(instance, value, fill = variable)) +\n  geom_bar(stat = \"identity\", width = 0.5) +\n  xlab(\"Jedinec\") +\n  ylab(\"Pravděpodobnost\") +\n  scale_fill_manual(values = c(\"#56B4E9\", \"#E69F00\"))\n\n\n```\n\nZde už vidíme zařazení jednotlivých jedinců do tříd (pohlaví) podle té pravděpodobnější z nich.\n\n```{r}\ndata.frame(Jedinec = 1:10, Pohlaví = data.test.predicted$class)\n```\n\n",
    "created" : 1570619857333.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "892599990",
    "id" : "10D0A5BB",
    "lastKnownWriteTime" : 1570619870,
    "last_content_update" : 1570619870654,
    "path" : "C:/code/R/vicerozmerna_statistika/ukol4.Rmd",
    "project_path" : "ukol4.Rmd",
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}